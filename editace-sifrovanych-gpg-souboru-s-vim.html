<!DOCTYPE html>
<html lang="en">
    <head>
        <title>Editace šifrovaných GPG souborů s vim @ stderr</title>

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="shortcut icon" href="favicon.ico" />

        <link href="http://stderr.cz/theme/css/bootstrap.min.css" rel="stylesheet">
        <link href="http://stderr.cz/theme/css/bootstrap-responsive.min.css" rel="stylesheet">
        <link href="http://stderr.cz/theme/css/pygment.css" rel="stylesheet">
        <link href="http://stderr.cz/theme/css/mystyle.css" rel="stylesheet">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,700,300&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <meta name="twitter:card" value="summary" />
    <meta name="twitter:creator" content="@kubiis" />
    <meta name="twitter:title" content="Editace šifrovaných GPG souborů s vim" />
    <meta name="twitter:description" content="Motivace Začnu zlehka motivací, kterou v klidu můžete přeskočit. Už nějakou chvíli přemýšlím, jak bezpečně uchovávat hesla. Měl jsem na to jen pár (= dva) požadavků: bezpečnost a dostupnost. ..." />

        <link rel="alternate" type="application/atom+xml" href="http://stderr.cz/feed.atom.xml" title="stderr ATOM/RSS Feed" />
        <!-- Minified Cookie Consent served from a CDN -->
        <script src="http://stderr.cz/theme/js/cookieconsent.js"></script>
        <!-- Begin Cookie Consent plugin by Silktide - http://silktide.com/cookieconsent -->
        <script type="text/javascript">
            window.cookieconsent_options = {"message":"Hej, psst! Přidej se na temnou stranu, mám tu koláčky (cookies)","dismiss":"Ano!","learnMore":"Více info","link":null,"theme":"light-floating"};
        </script>
    </head>

    <body>
    <div class="container">
        <div class="row">
            <div class="span9 offset2">
                <ul class="breadcrumb menu">
                    <li><a href="http://stderr.cz/o-autorovi">O autorovi</a></li>
                    <li><a href="http://stderr.cz/archives">Archiv</a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="span2 text-center">
                <div class="hero-unit">
                    <div id="avatar"></div>
                    <h1><a href="http://stderr.cz">stderr</a></h1>
                    <p>Jakub Jedelský</p>
                </div>
                <div class="metadata">
                    <ul class="social">
                            <li><a href="https://www.linkedin.com/in/jedelsky" target="_blank"><img src="http://stderr.cz/theme/social/linkedin-32.png" title="Linkedin" class="si-linkedin" /></a></li>
                            <li><a href="https://stderr.cz/feed.atom.xml" target="_blank"><img src="http://stderr.cz/theme/social/rss-32.png" title="Rss" class="si-rss" /></a></li>
                            <li><a href="https://twitter.com/kubiis" target="_blank"><img src="http://stderr.cz/theme/social/twitter-32.png" title="Twitter" class="si-twitter" /></a></li>
                            <li><a href="https://github.com/jakubjedelsky" target="_blank"><img src="http://stderr.cz/theme/social/github-32.png" title="Github" class="si-github" /></a></li>
                    </ul>
                </div>
            </div>
            <div class="span9">
<h2>Editace šifrovaných GPG souborů s vim</h2>
<time datetime=2011-09-08T00:00:00+02:00>08. 09. 2011</time><div class="flattr">
    <script id='flattrbtn'>
    (function(i) {
        var f,s=document.getElementById(i);
        f=document.createElement('iframe');
        f.src='//api.flattr.com/button/view/?uid=stderr&button=compact&url='+encodeURIComponent(document.URL)+'&title=Editace šifrovaných GPG souborů s vim';
        f.title='Flattr';
        f.height=20;
        f.width=110;
        f.style.borderWidth=0;
        s.parentNode.insertBefore(f,s);
        })
    ('flattrbtn');
    </script>
</div>
<div class="article">
<h3>Motivace</h3>
<p><em>Začnu zlehka motivací, kterou v klidu můžete přeskočit.</em><br />
Už nějakou chvíli přemýšlím, jak bezpečně uchovávat hesla. Měl jsem na
to jen pár (= dva) požadavků: <strong>bezpečnost</strong> a <strong>dostupnost</strong>.
Bezpečnost je jasná - kromě hesel na "srandastránky" potřebuji uložit
údaje k poměrně citlivým službám. A protože se k heslům potřebuji dostat
nepravidelně jak z kanceláře, tak z domu, tak z nějaké kavárny,
potřebuju nějaké centrální úložiště. Klikátka jsou passé kvůli druhému
požadavku, ukládání do databáze v plaintext na nějakém mém serveru se
zas nekamarádí s prvním požadavkem. A teď babo raď (nebo pište do
komentářů, co používáte vy).</p>
<p>Rozhodnutí padlo na obyčejný texťák zašifrovaný pomocí <a href="http://cs.wikipedia.org/wiki/GnuPG" title="GnuPG na Wikipedii">GnuPG</a>. Jak
jednodché. Tento soubor mám uložený na pracovním pc, který jede nonstop,
takže přes ssh si ho můžu přečíst kdykoliv. Ale přišly další problémy:
jak jej jednoduše editovat? Rozkódovat, přepsat, zakódovat - furt
dokolečka. Admini jsou přece lidé líní..</p>
<h3>vim umí všechno</h3>
<p>Mám rád <code>vim</code>, protože toho umí spoustu. Třeba rozkódovat, přepsat a
zakódovat GPG soubor - jé, o tom jsem psal o pár řádků výš, jaká náhoda!
Na řešení jsem dnes narazil na <a href="http://vim.wikia.com/wiki/Edit_gpg_encrypted_files#Related_plugins" title="Edit gpg encrypted files">vim wiki</a>. Jednoduše si do <code>~/.vimrc</code>
přidejte těchto pár řádků:</p>
<div class="highlight"><pre><span></span><span class="c">&quot; Transparent editing of gpg encrypted files.</span>
augroup encrypted
<span class="k">au</span><span class="p">!</span>
<span class="c">&quot; First make sure nothing is written to ~/.viminfo while editing</span>
<span class="c">&quot; an encrypted file.</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">set</span> <span class="nb">viminfo</span><span class="p">=</span>
<span class="c">&quot; We don&#39;t want a swap file, as it writes unencrypted data to disk</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">set</span> <span class="nb">noswapfile</span>
<span class="c">&quot; Switch to binary mode to read the encrypted file</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">set</span> <span class="nb">bin</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">let</span> ch_save <span class="p">=</span> &amp;<span class="nb">ch</span><span class="p">|</span><span class="k">set</span> <span class="nb">ch</span><span class="p">=</span><span class="m">2</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">let</span> shsave<span class="p">=</span>&amp;<span class="k">sh</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">let</span> &amp;<span class="k">sh</span><span class="p">=</span><span class="s1">&#39;sh&#39;</span>
autocmd <span class="nb">BufReadPre</span><span class="p">,</span><span class="nb">FileReadPre</span>      *.gpg <span class="k">let</span> ch_save <span class="p">=</span> &amp;<span class="nb">ch</span><span class="p">|</span><span class="k">set</span> <span class="nb">ch</span><span class="p">=</span><span class="m">2</span>
autocmd <span class="nb">BufReadPost</span><span class="p">,</span><span class="nb">FileReadPost</span>    *.gpg <span class="s1">&#39;[,&#39;</span>]<span class="p">!</span>gpg <span class="p">--</span>decrypt <span class="p">--</span>default<span class="p">-</span>recipient<span class="p">-</span>self <span class="m">2</span><span class="p">&gt;</span> <span class="sr">/dev/</span>null
autocmd <span class="nb">BufReadPost</span><span class="p">,</span><span class="nb">FileReadPost</span>    *.gpg <span class="k">let</span> &amp;<span class="k">sh</span><span class="p">=</span>shsave
<span class="c">&quot; Switch to normal mode for editing</span>
autocmd <span class="nb">BufReadPost</span><span class="p">,</span><span class="nb">FileReadPost</span>    *.gpg <span class="k">set</span> <span class="nb">nobin</span>
autocmd <span class="nb">BufReadPost</span><span class="p">,</span><span class="nb">FileReadPost</span>    *.gpg <span class="k">let</span> &amp;<span class="nb">ch</span> <span class="p">=</span> ch_save<span class="p">|</span>unlet ch_save
autocmd <span class="nb">BufReadPost</span><span class="p">,</span><span class="nb">FileReadPost</span>    *.gpg execute <span class="s2">&quot;:doautocmd BufReadPost &quot;</span> . expand<span class="p">(</span><span class="s2">&quot;%:r&quot;</span><span class="p">)</span>
<span class="c">&quot; Convert all text to encrypted text before writing</span>
autocmd <span class="nb">BufWritePre</span><span class="p">,</span><span class="nb">FileWritePre</span>    *.gpg <span class="k">set</span> <span class="nb">bin</span>
autocmd <span class="nb">BufWritePre</span><span class="p">,</span><span class="nb">FileWritePre</span>    *.gpg <span class="k">let</span> shsave<span class="p">=</span>&amp;<span class="k">sh</span>
autocmd <span class="nb">BufWritePre</span><span class="p">,</span><span class="nb">FileWritePre</span>    *.gpg <span class="k">let</span> &amp;<span class="k">sh</span><span class="p">=</span><span class="s1">&#39;sh&#39;</span>
autocmd <span class="nb">BufWritePre</span><span class="p">,</span><span class="nb">FileWritePre</span>    *.gpg <span class="s1">&#39;[,&#39;</span>]<span class="p">!</span>gpg <span class="p">--</span>encrypt <span class="p">--</span>default<span class="p">-</span>recipient<span class="p">-</span>self <span class="m">2</span><span class="p">&gt;</span><span class="sr">/dev/</span>null
autocmd <span class="nb">BufWritePre</span><span class="p">,</span><span class="nb">FileWritePre</span>    *.gpg <span class="k">let</span> &amp;<span class="k">sh</span><span class="p">=</span>shsave
<span class="c">&quot; Undo the encryption so we are back in the normal text, directly</span>
<span class="c">&quot; after the file has been written.</span>
autocmd <span class="nb">BufWritePost</span><span class="p">,</span><span class="nb">FileWritePost</span>  *.gpg <span class="k">silent</span> <span class="k">u</span>
autocmd <span class="nb">BufWritePost</span><span class="p">,</span><span class="nb">FileWritePost</span>  *.gpg <span class="k">set</span> <span class="nb">nobin</span>
augroup END
</pre></div>


<p>A šup s radostí editovat Vaše šifrované soubory. A na závěr poznámka:
pokud používáte více soukromých klíčů, tak myslete na to, že v
konfiguraci se používá přepínač <code>--default-recipient-self</code>.</p>
</div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'stderr-cz-blog';
    var disqus_title = 'Editace šifrovaných GPG souborů s vim';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Komentáře pouze s JavaScriptem.</noscript>
            </div>
        </div>
    </div>

    <div class="footer">
	<p class="text-center" style="color: #666;">vzniká od r. 2009</p>
    </div>
    </body>
</html>